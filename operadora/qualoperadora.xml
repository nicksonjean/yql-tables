<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
    <meta>
        <author>Nickson Jeanmerson</author>
        <description>Verifica a operadora de um número telefênico</description>
        <sampleQuery><![CDATA[SELECT * FROM {table} WHERE tel="foo" AND xpath='//div[@class="resultado"]']]></sampleQuery>
        <documentationURL></documentationURL>
    </meta>
    <bindings>
        <select itemPath="" produces="XML">
            <urls>
                <url>{url}</url>
            </urls>
            <inputs>
                <key id="tel" type="xs:string" required="true" paramType="variable"/>
                <key id="xpath" type="xs:string" required="false" paramType="variable"/>
            </inputs>
            <execute>
                <![CDATA[
                    y.include("https://raw.githubusercontent.com/nicksonjean/yql-tables/master/utils/scripts/random_useragent/random_useragent.min.js");
                    var cookie = "";
                    function getcookie(headers, cookie) {
                        var cookies = headers['set-cookie'];
                        if (cookies instanceof Array) { 
                            for (c in cookies) { 
                                cookie += cookies[c].split(';')[0] + "; "
                            }
                        }
                        else {
                            if (cookies) {
                                cookie = cookies.split(';')[0] + "; ";
                            }
                        }
                        return cookie;
                    }
                    function handleRedirect(request) {
                        while (request.status == 301 || request.status == 302) {
                            cookie = getcookie(request.headers, cookie);
                            request = y.rest(request.headers.location).accept("text/html");
                            if (cookie != "") { 
                                request = request.header("Cookie", cookie);
                            }
                            request = request.get();
                        }
                        return request;
                    }

                    var _ua = random_useragent();
                    var _url = 'http://qualoperadora.info/';

                    var request = y.rest(_url).followRedirects(false).accept("text/html").get();
                    request = handleRedirect(request);
                    var headers = request.headers;

                    var _request = y.rest(_url + 'consulta');
                    var _data = null;
                    y.log('Cookies: ' + request.headers.location);
                    y.log('Browser: ' + _ua.toString().replace(/,/g, ""));

                    _data = _request
                                .accept('text/html')
                                .contentType("application/x-www-form-urlencoded")
                                .header('Accept-Encoding', 'gzip,deflate')
                                .header('Accept-Language', 'pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4')
                                .header('Origin', 'http//qualoperadora.info')
                                .header('Referer', 'http//qualoperadora.info/')
                                .header('Cookie', cookie)
                                .decompress(true)
                                .followRedirects(false)
                                .header('User-Agent', _ua)
                                .post('tel='+tel)
                                .response;

                    if(xpath) {
                        var xdata = y.xpath(_data,xpath);
                        response.object = <postresult>{xdata}</postresult>;
                    }
                    else {
                        response.object = <postresult>{_data}</postresult>;
                    }
                ]]>
            </execute>
        </select>
    </bindings>
</table>
